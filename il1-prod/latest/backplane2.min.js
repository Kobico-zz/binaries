!function(e){var n={};function s(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=e,s.c=n,s.d=function(e,n,t){s.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,n){if(1&n&&(e=s(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)s.d(t,a,function(n){return e[n]}.bind(null,a));return t},s.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},s.p="",s(s.s=383)}({383:function(e,n){var s;window.Backplane=window.Backplane||((s=function(e){if(Backplane.getChannelID())e();else{var n=Backplane.onInit;Backplane.onInit=function(){n(),e()}}}).log=function(e){window.console&&window.console.log&&console.log("Backplane: "+e)},s.warn=function(e){window.console&&window.console.warn&&console.warn("Backplane WARNING: "+e)},s.error=function(e){window.console&&window.console.error&&console.error("Backplane ERROR: "+e)},s.version="2.0.6",s.token=null,s.refresh_token=null,s.channelName=null,s.block=0,s.config={},s.runRequests=!1,s.firstFrameReceived=!1,s.replayOnPageLoad=!1,s.memoryCachedMessages={},s.memoryCachedMessagesIndex=[],s.cacheMax=10,s.subscribers={},s.messageCacheIndexKey="backplane2CachedMessagesIndex",s.messageCacheKey="backplane2CachedMessages",s.messageCacheExpires="backplane2CacheExpires",s.timers={},s.awaiting={since:0,until:0,queue:[]},s.intervals={min:1,frequent:5,regular:20,slowdown:120},s.onInit=function(){},s.log("backplane2.js loaded"),s),Backplane.init=function(e){return this.log("initializing"),(e=e||{}).serverBaseURL?e.busName?(this.timers={},this.config=e,this.config.serverBaseURL=this.normalizeURL(e.serverBaseURL),0>this.config.serverBaseURL.indexOf("/v2")?(this.error("serverBaseURL must include '/v2'"),!1):(this.loadChannelFromCookie(),this.cacheMax=e.cacheMax||this.cacheMax,this.replayOnPageLoad=e.replayOnPageLoad||this.replayOnPageLoad,this.block=e.block||0,void 0===this.config.channelExpires&&((e=new Date).setFullYear(e.getFullYear()+5),this.config.channelExpires=e.toGMTString()),this.getChannelName()?(this.syncMemoryCache(),this.onInit(),this.request()):(this.invalidateCache(),this.fetchNewChannel()),!0)):(this.error("must supply busName"),!1):(this.error("must supply serverBaseURL"),!1)},Backplane.subscribe=function(e,n){if(!this.getChannelName())return!1;void 0===n&&(n=this.replayOnPageLoad),this.checkSubscribers()||(this.runRequests=!0,this.request());var s,t=(new Date).getTime()+Math.random(),a={id:t,callback:e,wantsReplays:n};if(this.subscribers[t]=a,this.firstFrameReceived||a.wantsReplays)for(s=0;s<this.memoryCachedMessagesIndex.length;s++)a.callback(this.memoryCachedMessages[this.memoryCachedMessagesIndex[s]]);return t},Backplane.getCachedMessages=function(){var e,n,s,t,a,i=[],r=[],o={};if(window.localStorage&&(e=window.localStorage.getItem(this.messageCacheIndexKey),n=window.localStorage.getItem(this.messageCacheKey),e&&n)){try{for(s=JSON.parse(e),o=JSON.parse(n),a=0;a<s.length;a++)t=o[s[a]],new Date(t.expire)>new Date?(i.push(t),r.push(s[a])):delete o[s[a]]}catch(e){this.error("failed to parse cached message data")}window.localStorage.setItem(this.messageCacheIndexKey,JSON.stringify(r)),window.localStorage.setItem(this.messageCacheKey,JSON.stringify(o))}return i},Backplane.syncMemoryCache=function(){this.memoryCachedMessages={},this.memoryCachedMessagesIndex=[];var e=Backplane.getCachedMessages();for(i=0;i<e.length;i++)Backplane.addMessageToMemoryCache(e[i])},Backplane.addMessageToMemoryCache=function(e){this.memoryCachedMessages.hasOwnProperty(e.messageURL)||(this.memoryCachedMessages[e.messageURL]=e,this.memoryCachedMessagesIndex.push(e.messageURL)),this.memoryCachedMessagesIndex.length>this.cacheMax&&(delete this.memoryCachedMessages[this.memoryCachedMessagesIndex[0]],this.memoryCachedMessagesIndex.splice(0,1))},Backplane.addMessageToLongTermCache=function(e){var n,s,t=[],a={};if(window.localStorage){if(n=window.localStorage.getItem(this.messageCacheIndexKey),s=window.localStorage.getItem(this.messageCacheKey),n&&s)try{t=JSON.parse(n),a=JSON.parse(s)}catch(e){this.error("failed to parse cached message data")}a[e.messageURL]=e,Backplane.inArray(t,e.messageURL)||t.push(e.messageURL),t.sort(),window.localStorage.setItem(this.messageCacheIndexKey,JSON.stringify(t)),window.localStorage.setItem(this.messageCacheKey,JSON.stringify(a))}},Backplane.inArray=function(e,n){for(var s=0;s<e.length;s++)if(e[s]===n)return!0;return!1},Backplane.unsubscribe=function(e){if(!e)return!1;delete this.subscribers[e],this.checkSubscribers()||(this.runRequests=!1)},Backplane.getChannelID=function(){return!!this.getChannelName()&&this.channelID},Backplane.expectMessages=function(e){this.expectMessagesWithin(60,e)},Backplane.expectMessagesWithin=function(e,n){if(!this.getChannelName()||!e)return!1;this.awaiting.since=this.getTS(),this.awaiting.interval=e,this.awaiting.nonstop=!n,n&&(n="string"==typeof n?[n]:n,this.awaiting.queue.push(n));var s=this.awaiting.since+e;s>this.awaiting.until&&(this.awaiting.until=s),this.request()},Backplane.finishInit=function(e){var n,s;if(this.log("received access token and channel from server"),null!=e.error)this.error("Error initializing backplane token: "+e.error);else{for(this.token=e.access_token,this.refresh_token=e.refresh_token,e=e.scope.split(" "),n=0;n<e.length;n++)-1<e[n].indexOf("channel:")&&(s=e[n].split(":"),this.channelName=s[1],this.log("channel set to: "+this.channelName));null===this.channelName?this.error("No channel found in the returned scope"):(this.setCookieChannel(),this.channelID=this.generateChannelID(),this.log("channelID = "+this.channelID),this.subscribers={},this.onInit(),this.fetchMessages())}},Backplane.generateNextFrameURL=function(){var e;return void 0===this.since&&(this.since=this.config.serverBaseURL+"/messages"),(e=-1<(e=this.since).indexOf("?")?e+"&":e+"?")+"callback=Backplane.response&access_token="+this.token+"&block="+this.block+"&rnd="+Math.random()},Backplane.generateChannelID=function(){return this.config.serverBaseURL+"/bus/"+this.config.busName+"/channel/"+this.channelName},Backplane.getChannelName=function(){return null!==this.channelName&&this.channelName},Backplane.getTS=function(){return Math.round((new Date).getTime()/1e3)},Backplane.checkSubscribers=function(){for(var e in this.subscribers)if(this.subscribers.hasOwnProperty(e))return!0;return!1},Backplane.loadChannelFromCookie=function(){var e,n;if(!(n=(document.cookie||"").match(/backplane2-channel=([\w\W]*?)(?:$|;)/))||!n[1])return{};e=n[1].split(":"),this.token=decodeURIComponent(e[0]),this.channelName=decodeURIComponent(e[1]),void 0!==e[2]&&(this.log("found refresh token in cookie"),this.refresh_token=decodeURIComponent(e[2])),20>this.token.length||30>this.channelName.length||void 0!==e[2]&&20>this.refresh_token.length?this.error("backplane2-channel value: '"+n[1]+"' is corrupt"):(this.log("retrieved token and channel from cookie"),this.channelID=this.generateChannelID(),this.log("channelID = "+this.channelID))},Backplane.setCookieChannel=function(){document.cookie="backplane2-channel="+encodeURIComponent(this.token)+":"+encodeURIComponent(this.channelName)+":"+encodeURIComponent(this.refresh_token)+";expires="+this.config.channelExpires+";path=/"},Backplane.resetCookieChannel=function(){this.invalidateCache(),this.refresh_token=this.token=this.channelName=null,this.setCookieChannel(),this.fetchNewChannel()},Backplane.makeCall=function(e,n,s){var t,a;n+="Id";for(t=document.getElementById(n);t;){for(a in t.parentNode.removeChild(t),t)delete t[a];t=document.getElementById(n)}(a=document.createElement("script")).type="text/javascript",a.id=n,void 0!==s&&(a.charset=s),a.src=e,(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(a,e)},Backplane.fetchNewChannel=function(){var e=this.config.serverBaseURL+"/token?callback=Backplane.finishInit&bus="+this.config.busName+"&rnd="+Math.random();Backplane.makeCall(e,"fetchNewChannel")},Backplane.invalidateCache=function(){this.log("removing cached backplane messages"),this.memoryCachedMessages={},this.memoryCachedMessagesIndex=[],window.localStorage&&(window.localStorage.removeItem(this.messageCacheExpires),window.localStorage.removeItem(this.messageCacheKey),window.localStorage.removeItem(this.messageCacheIndexKey))},Backplane.refreshToken=function(){var e=this.config.serverBaseURL+"/token?callback=Backplane.refreshTokenResponse&refresh_token="+this.refresh_token+"&rnd="+Math.random();this.makeCall(e,"refreshToken")},Backplane.refreshTokenResponse=function(e){void 0!==e.error_description?"invalid token"===e.error_description?(this.log("received invalid token error from server when refreshing access token; requesting new access token"),this.resetCookieChannel()):this.log("received unexpected error from server when refreshing access token: "+e.error_description):(this.log("received refreshed access token from server"),this.token=e.access_token,this.refresh_token=e.refresh_token,this.setCookieChannel())},Backplane.normalizeURL=function(e){return e.replace(/^\s*(https?:\/\/)?([\w\W]*?)[\s\/]*$/,function(e,n,s){return(n||window.location.protocol+"//")+s})},Backplane.calcTimeout=function(){var e,n;if((e=this.getTS())<this.awaiting.until){if(!this.awaiting.nonstop&&!this.awaiting.queue.length)return this.awaiting.until=e,this.calcTimeout();e-=this.awaiting.since,n=this.intervals.frequent-this.intervals.min,e=this.intervals.min+Math.round(n*e/this.awaiting.interval)}else e<this.awaiting.until+this.intervals.slowdown?(e-=this.awaiting.until,n=this.intervals.regular-this.intervals.frequent,e=this.intervals.frequent+Math.round(n*e/this.intervals.slowdown)):(e=void 0===this.since?0:this.intervals.regular,this.awaiting.nonstop=!1);return 1e3*e},Backplane.fetchMessages=function(){var e=Backplane.generateNextFrameURL();Backplane.makeCall(e,"fetchMessages","utf-8")},Backplane.convertMessageURLtoNextURL=function(e,n){var s=this.config.serverBaseURL||n;return e.replace(s+"/message/",s+"/messages?since=")},Backplane.request=function(){var e=this;if(!this.getChannelName()||!this.runRequests)return!1;this.stopTimer("regular"),this.stopTimer("watchdog"),this.timers.regular=setTimeout(function(){if(e.timers.watchdog=setTimeout(function(){e.request()},1e3*Backplane.block+5e3),!e.since){var n=e.getCachedMessages();e.log(n.length+" message(s) in cache"),0<n.length&&(e.since=e.convertMessageURLtoNextURL(n[n.length-1].messageURL)),e.replayOnPageLoad&&Backplane.syncMemoryCache()}Backplane.fetchMessages()},this.calcTimeout())},Backplane.response=function(e){var n,s,t,a,i,r;if(this.stopTimer("watchdog"),void 0!==e.error_description)"invalid token"===e.error_description?(this.log("received invalid token error from server when retrieving messages"),this.refresh_token?(this.log("refreshing access token"),this.refreshToken()):(this.log("refresh token is not available; requesting new access token"),this.resetCookieChannel())):(this.log("received unexpected error from server when retrieving messages: "+e.error_description),this.log("...trying again")),this.request();else{for(this.since=e.nextURL,n=0;n<e.messages.length;n++){for(s in Backplane.addMessageToLongTermCache(e.messages[n]),Backplane.addMessageToMemoryCache(e.messages[n]),this.subscribers)this.subscribers.hasOwnProperty(s)&&this.subscribers[s].callback(e.messages[n]);for(r=[],t=0;t<this.awaiting.queue.length;t++){for(i=!1,a=0;a<this.awaiting.queue[t].length;a++)this.awaiting.queue[t][a]===e.messages[n].type&&(i=!0);i||r.push(this.awaiting.queue[t])}this.awaiting.queue=r}!0===e.moreMessages?this.fetchMessages():(this.firstFrameReceived=!0,this.request())}},Backplane.stopTimer=function(e){(e=this.timers[e])&&clearTimeout(e)}}});